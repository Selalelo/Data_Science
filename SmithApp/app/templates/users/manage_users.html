{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}
{% block extra_css %}
<style>
    h1 { color: #2d3748; margin-bottom: 20px; }
    .actions { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn:hover { background: #5a67d8; }
    .btn-success { background: #48bb78; }
    .btn-success:hover { background: #38a169; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f7fafc; color: #2d3748; font-weight: 600; cursor: pointer; user-select: none; }
    th:hover { background: #edf2f7; }
    tr:hover { background: #f7fafc; }
    .btn-small { padding: 5px 15px; font-size: 14px; margin-right: 5px; }
    .btn-edit { background: #4299e1; }
    .btn-edit:hover { background: #3182ce; }
    .btn-delete { background: #f56565; }
    .btn-delete:hover { background: #e53e3e; }
</style>
{% endblock %}

{% block content %}
<h1>Manage Users</h1>
<div class="actions">
    <span>Total Users: {{ users|length }}</span>
    <a href="/api/users/export/word" class="btn btn-success">Export to MS Word</a>
</div>
<table id="usersTable">
    <thead>
        <tr>
            <th onclick="sortTable(0)">Name ↕</th>
            <th onclick="sortTable(1)">Date of Birth ↕</th>
            <th onclick="sortTable(2)">Province ↕</th>
            <th onclick="sortTable(3)">Gender ↕</th>
            <th onclick="sortTable(4)">Facilitator ↕</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for user_item in users %}
    <tr>
        <td>{{ user_item.full_name }}</td>
        <td>{{ user_item.date_of_birth }}</td>
        <td>{{ user_item.province }}</td>
        <td>{{ user_item.gender }}</td>
        <td>{{ 'Yes' if user_item.facilitator else 'No' }}</td>
        <td>
            {# EDIT BUTTON LOGIC #}
            {# Show if logged-in user is Admin (ID 1) OR if the row belongs to the logged-in user #}
            {% if user.user_id == 1 or user.user_id == user_item.user_id %}
                <a href="/users/edit/{{ user_item.user_id }}" class="btn btn-small btn-edit">Edit</a>
            {% endif %}

            {# DELETE BUTTON LOGIC #}
            {# Show only if logged-in user is Admin (ID 1) AND the row is NOT the Admin themselves #}
            {% if user.user_id == 1 and user_item.user_id != 1 %}
                <a href="/users/delete/{{ user_item.user_id }}" class="btn btn-small btn-delete">Delete</a>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</tbody>

</table>

<script>
function sortTable(columnIndex) {
    const table = document.getElementById('usersTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const aText = a.children[columnIndex].textContent.trim();
        const bText = b.children[columnIndex].textContent.trim();
        return aText.localeCompare(bText);
    });
    
    rows.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}
